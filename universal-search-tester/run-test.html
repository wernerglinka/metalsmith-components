<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Search Tester - Browser Edition</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
            color: #2d3748;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .header {
            text-align: center;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .upload-area {
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            background: white;
            margin-bottom: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: #4299e1;
            background: #ebf8ff;
        }
        .config-panel {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #4a5568;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 1rem;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .btn:hover { background: #3182ce; }
        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #edf2f7;
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
            display: none;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4299e1, #63b3ed);
            width: 0%;
            transition: width 0.3s ease;
        }
        .results {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 2rem;
            display: none;
        }
        .results-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e2e8f0;
            background: linear-gradient(90deg, #4299e1, #63b3ed);
            color: white;
            border-radius: 12px 12px 0 0;
        }
        .results-body { padding: 2rem; }
        .quality-score {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 2rem;
        }
        .score-A { color: #38a169; }
        .score-B { color: #3182ce; }
        .score-C { color: #d69e2e; }
        .score-D { color: #dd6b20; }
        .score-F { color: #e53e3e; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: #f7fafc;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4299e1;
        }
        .issues-section, .recommendations-section {
            margin-top: 2rem;
        }
        .issue-item, .recommendation-item {
            background: #fed7d7;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 6px;
            border-left: 4px solid #e53e3e;
        }
        .recommendation-item {
            background: #bee3f8;
            border-left-color: #3182ce;
        }
        .log {
            background: #1a202c;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
            display: none;
        }
        .show-log { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Universal Search Tester</h1>
            <p>Browser Edition - Test your search index without any setup!</p>
        </div>

        <div class="upload-area" onclick="document.getElementById('fileInput').click()" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
            <div id="uploadText">
                <h3>üìÅ Upload Search Index</h3>
                <p>Drag and drop your <strong>search-index.json</strong> file here<br>or click to browse</p>
                <p><small>Example format available in <strong>example-index.json</strong></small></p>
            </div>
            <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileSelect(event)">
        </div>

        <div class="config-panel">
            <h3>‚öôÔ∏è Test Configuration</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="threshold">Relevance Threshold (%)</label>
                    <input type="number" id="threshold" value="70" min="0" max="100">
                </div>
                <div class="form-group">
                    <label for="maxResults">Max Results per Term</label>
                    <input type="number" id="maxResults" value="20" min="1" max="100">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="categories">Test Categories</label>
                    <select id="categories" multiple size="3">
                        <option value="validTerms" selected>Valid Terms (~170 terms)</option>
                        <option value="invalidTerms" selected>Invalid Terms (~120 terms)</option>
                        <option value="edgeCases" selected>Edge Cases (~160 terms)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button class="btn" id="runTest" disabled onclick="runTest()">üöÄ Run Search Test</button>
                </div>
            </div>
        </div>

        <div class="progress" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div id="log" class="log"></div>

        <div class="results" id="results">
            <div class="results-header">
                <h2>üìä Test Results</h2>
                <p id="testSummary"></p>
            </div>
            <div class="results-body">
                <div class="quality-score" id="qualityScore"></div>
                
                <div class="stats-grid" id="statsGrid"></div>

                <div class="issues-section" id="issuesSection" style="display: none;">
                    <h3>‚ö†Ô∏è Issues Found</h3>
                    <div id="issuesList"></div>
                </div>

                <div class="recommendations-section" id="recommendationsSection" style="display: none;">
                    <h3>üí° Recommendations</h3>
                    <div id="recommendationsList"></div>
                </div>

                <div style="margin-top: 2rem; text-align: center;">
                    <button class="btn" onclick="downloadResults()">üì• Download JSON Results</button>
                    <button class="btn" onclick="toggleLog()">üìã Toggle Debug Log</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        let searchIndex = null;
        let testResults = null;

        // Test terms dataset (embedded)
        const testTerms = {
            validTerms: [
                'time', 'person', 'world', 'life', 'work', 'home', 'page', 'search', 'help', 'contact',
                'make', 'find', 'create', 'build', 'learn', 'good', 'new', 'important', 'available', 'free'
            ],
            invalidTerms: [
                'asdf', 'qwerty', 'xyz', 'zzz', 'ing', 'tion', 'ment', 'teh', 'recieve', 'seperate'
            ],
            edgeCases: [
                '', ' ', 'a', 'TEST', 'test', 'hello world', 'contact us', '123', '@test', 'caf√©'
            ]
        };

        // Simple search implementation
        class SimpleSearch {
            constructor(data, options = {}) {
                this.data = data;
                this.options = {
                    threshold: options.threshold || 0.3,
                    minMatchCharLength: options.minMatchCharLength || 3,
                    ...options
                };
            }

            search(query) {
                if (!query || query.length < this.options.minMatchCharLength) return [];
                
                const results = [];
                const queryLower = query.toLowerCase();

                this.data.forEach((item, index) => {
                    let score = this.calculateScore(queryLower, item);
                    
                    if (score < this.options.threshold) {
                        results.push({ item, score, refIndex: index });
                    }
                });

                return results.sort((a, b) => a.score - b.score);
            }

            calculateScore(query, item) {
                let bestScore = 1.0;
                const fields = ['title', 'content', 'pageName', 'tags', 'leadIn', 'prose'];
                
                fields.forEach(field => {
                    if (item[field]) {
                        const fieldValue = Array.isArray(item[field]) ? 
                            item[field].join(' ') : item[field].toString();
                        const score = this.fieldScore(query, fieldValue.toLowerCase());
                        if (score < bestScore) bestScore = score;
                    }
                });
                
                return bestScore;
            }

            fieldScore(query, text) {
                if (text.includes(query)) return 0.1;
                
                const distance = this.levenshteinDistance(query, text);
                return distance / Math.max(query.length, text.length);
            }

            levenshteinDistance(str1, str2) {
                const matrix = [];
                for (let i = 0; i <= str2.length; i++) matrix[i] = [i];
                for (let j = 0; j <= str1.length; j++) matrix[0][j] = j;
                
                for (let i = 1; i <= str2.length; i++) {
                    for (let j = 1; j <= str1.length; j++) {
                        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j - 1] + 1,
                                matrix[i][j - 1] + 1,
                                matrix[i - 1][j] + 1
                            );
                        }
                    }
                }
                
                return matrix[str2.length][str1.length];
            }
        }

        // File handling
        window.handleFileSelect = function(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/json') {
                loadSearchIndex(file);
            } else {
                alert('Please select a valid JSON file');
            }
        };

        window.handleDrop = function(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('dragover');
            
            const file = event.dataTransfer.files[0];
            if (file && file.type === 'application/json') {
                loadSearchIndex(file);
            } else {
                alert('Please drop a valid JSON file');
            }
        };

        window.handleDragOver = function(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        };

        window.handleDragLeave = function(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
        };

        function loadSearchIndex(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    searchIndex = data.entries ? data : { entries: data };
                    
                    document.getElementById('uploadText').innerHTML = `
                        <h3>‚úÖ Search Index Loaded</h3>
                        <p><strong>${file.name}</strong> (${searchIndex.entries.length} entries)</p>
                        <p>Ready to run tests!</p>
                    `;
                    
                    document.getElementById('runTest').disabled = false;
                    log(`Loaded search index: ${searchIndex.entries.length} entries`);
                } catch (error) {
                    alert('Error parsing JSON file: ' + error.message);
                    log('Error loading search index: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Test execution
        window.runTest = async function() {
            if (!searchIndex) return;

            const config = {
                relevanceThreshold: parseInt(document.getElementById('threshold').value),
                maxResults: parseInt(document.getElementById('maxResults').value),
                categories: Array.from(document.getElementById('categories').selectedOptions).map(o => o.value)
            };

            document.getElementById('runTest').disabled = true;
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('log').classList.add('show-log');
            
            log(`Starting search test with ${config.categories.length} categories...`);
            log(`Config: threshold=${config.relevanceThreshold}%, maxResults=${config.maxResults}`);

            // Initialize search engine
            const searchEngine = new SimpleSearch(searchIndex.entries, {
                threshold: 0.2,
                minMatchCharLength: 4
            });

            // Collect test terms
            const allTests = [];
            config.categories.forEach(category => {
                if (testTerms[category]) {
                    testTerms[category].forEach(term => {
                        allTests.push({ term, category });
                    });
                }
            });

            log(`Testing ${allTests.length} terms...`);

            // Run tests
            const results = [];
            for (let i = 0; i < allTests.length; i++) {
                const { term, category } = allTests[i];
                const progress = Math.round((i / allTests.length) * 100);
                
                document.getElementById('progressBar').style.width = progress + '%';
                
                const result = testSingleTerm(searchEngine, term, category, config);
                results.push(result);

                if (i % 50 === 0) {
                    log(`Progress: ${i}/${allTests.length} (${progress}%)`);
                    await new Promise(resolve => setTimeout(resolve, 1)); // Allow UI update
                }
            }

            document.getElementById('progressBar').style.width = '100%';
            log('Analyzing results...');

            // Analyze results
            const analysis = analyzeResults(results, config);
            
            testResults = { results, analysis, config, timestamp: new Date().toISOString() };
            
            displayResults(testResults);
            document.getElementById('runTest').disabled = false;
            document.getElementById('progressContainer').style.display = 'none';
            
            log('Test completed!');
        };

        function testSingleTerm(searchEngine, term, category, config) {
            const startTime = Date.now();
            
            if (term.length < 2 && term.trim().length > 0) {
                return {
                    term, category,
                    results: [],
                    totalResults: 0,
                    relevantResults: 0,
                    executionTime: 0,
                    error: 'Term too short'
                };
            }
            
            try {
                const searchResults = searchEngine.search(term);
                const relevantResults = searchResults.filter(result => {
                    const relevance = (1 - result.score) * 100;
                    return relevance >= config.relevanceThreshold;
                });
                
                return {
                    term, category,
                    results: relevantResults.slice(0, config.maxResults).map(result => ({
                        title: result.item.title || 'Untitled',
                        url: result.item.url || '#',
                        score: Math.round((1 - result.score) * 100)
                    })),
                    totalResults: searchResults.length,
                    relevantResults: relevantResults.length,
                    executionTime: Date.now() - startTime
                };
            } catch (error) {
                return {
                    term, category,
                    results: [],
                    totalResults: 0,
                    relevantResults: 0,
                    executionTime: Date.now() - startTime,
                    error: error.message
                };
            }
        }

        function analyzeResults(results, config) {
            const analysis = {
                summary: {
                    totalTerms: results.length,
                    termsWithResults: results.filter(r => r.relevantResults > 0).length,
                    termsWithErrors: results.filter(r => r.error).length,
                    avgExecutionTime: Math.round(
                        results.reduce((sum, r) => sum + r.executionTime, 0) / results.length
                    )
                },
                byCategory: {},
                issues: [],
                recommendations: [],
                qualityScore: 0
            };

            // Analyze by category
            config.categories.forEach(category => {
                const categoryResults = results.filter(r => r.category === category);
                if (categoryResults.length === 0) return;

                analysis.byCategory[category] = {
                    totalTerms: categoryResults.length,
                    termsWithResults: categoryResults.filter(r => r.relevantResults > 0).length,
                    successRate: Math.round(
                        (categoryResults.filter(r => r.relevantResults > 0).length / categoryResults.length) * 100
                    )
                };
            });

            // Identify issues
            const invalidWithResults = results.filter(r => 
                r.category === 'invalidTerms' && r.relevantResults > 0
            );
            
            if (invalidWithResults.length > 0) {
                analysis.issues.push({
                    type: 'false_positives',
                    count: invalidWithResults.length,
                    description: 'Invalid terms returning results',
                    terms: invalidWithResults.slice(0, 5).map(r => r.term)
                });
            }

            const validWithoutResults = results.filter(r => 
                r.category === 'validTerms' && r.relevantResults === 0
            );
            
            if (validWithoutResults.length > 0) {
                analysis.issues.push({
                    type: 'false_negatives',
                    count: validWithoutResults.length,
                    description: 'Valid terms returning no results',
                    terms: validWithoutResults.slice(0, 5).map(r => r.term)
                });
            }

            // Generate recommendations
            if (invalidWithResults.length > 0) {
                analysis.recommendations.push('Increase search threshold to reduce false positives');
            }
            
            if (analysis.byCategory.validTerms?.successRate < 70) {
                analysis.recommendations.push('Reduce search threshold to improve recall');
            }

            // Calculate quality score
            let score = 100;
            analysis.issues.forEach(issue => {
                score -= issue.count > 5 ? 20 : 10;
            });
            
            analysis.qualityScore = Math.max(0, score);
            return analysis;
        }

        function displayResults(testResults) {
            const { analysis } = testResults;
            
            // Show results panel
            document.getElementById('results').style.display = 'block';
            
            // Test summary
            document.getElementById('testSummary').textContent = 
                `Tested ${analysis.summary.totalTerms} terms in ${analysis.summary.avgExecutionTime}ms average`;
            
            // Quality score
            const grade = getGrade(analysis.qualityScore);
            document.getElementById('qualityScore').innerHTML = 
                `<span class="score-${grade}">Quality Score: ${analysis.qualityScore}/100 (Grade ${grade})</span>`;
            
            // Stats grid
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-number">${analysis.summary.totalTerms}</div>
                    <div>Total Terms</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${analysis.summary.termsWithResults}</div>
                    <div>With Results</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${analysis.summary.termsWithErrors}</div>
                    <div>Errors</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${analysis.summary.avgExecutionTime}ms</div>
                    <div>Avg Time</div>
                </div>
            `;
            document.getElementById('statsGrid').innerHTML = statsHtml;

            // Issues
            if (analysis.issues.length > 0) {
                document.getElementById('issuesSection').style.display = 'block';
                document.getElementById('issuesList').innerHTML = analysis.issues.map(issue => 
                    `<div class="issue-item">
                        <strong>${issue.description}</strong> (${issue.count} terms)<br>
                        Examples: ${issue.terms.join(', ')}
                    </div>`
                ).join('');
            }

            // Recommendations
            if (analysis.recommendations.length > 0) {
                document.getElementById('recommendationsSection').style.display = 'block';
                document.getElementById('recommendationsList').innerHTML = analysis.recommendations.map(rec => 
                    `<div class="recommendation-item">${rec}</div>`
                ).join('');
            }

            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function getGrade(score) {
            if (score >= 90) return 'A';
            if (score >= 80) return 'B';
            if (score >= 70) return 'C';
            if (score >= 60) return 'D';
            return 'F';
        }

        // Utility functions
        function log(message) {
            const logElement = document.getElementById('log');
            logElement.innerHTML += `${new Date().toLocaleTimeString()}: ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        window.downloadResults = function() {
            if (!testResults) return;
            
            const blob = new Blob([JSON.stringify(testResults, null, 2)], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'search-test-results.json';
            a.click();
            URL.revokeObjectURL(url);
        };

        window.toggleLog = function() {
            const log = document.getElementById('log');
            log.classList.toggle('show-log');
        };
    </script>
</body>
</html>