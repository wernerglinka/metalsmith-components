<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendar API Debug Tool</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    .controls {
      background: #f5f5f5;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
    }
    .control-group {
      margin-bottom: 1rem;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    input, button {
      padding: 0.5rem;
      font-size: 1rem;
    }
    input[type="text"] {
      width: 100%;
      max-width: 600px;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 0.5rem;
    }
    button:hover {
      background: #2563eb;
    }
    .results {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 1.5rem;
    }
    .result-section {
      margin-bottom: 2rem;
    }
    .result-section h3 {
      margin-top: 0;
      color: #1f2937;
    }
    pre {
      background: #f9fafb;
      padding: 1rem;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 0.875rem;
    }
    .event-item {
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      background: #f0f9ff;
      border-left: 3px solid #3b82f6;
      border-radius: 4px;
    }
    .event-item strong {
      display: block;
      margin-bottom: 0.25rem;
    }
    .event-item small {
      color: #6b7280;
    }
    .warning {
      background: #fef3c7;
      border-left: 3px solid #f59e0b;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 4px;
    }
    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 1rem;
    }
    .comparison > div {
      border: 1px solid #e5e7eb;
      padding: 1rem;
      border-radius: 4px;
    }
    .comparison h4 {
      margin-top: 0;
    }
  </style>
</head>
<body>
  <h1>Google Calendar API Debug Tool</h1>
  <p>Test how Google Calendar API returns recurring events with different date ranges.</p>

  <div class="controls">
    <div class="control-group">
      <label for="apiKey">Google Calendar API Key:</label>
      <input type="text" id="apiKey" placeholder="Your API key" value="AIzaSyCuPRkCrwjjf_cAIlibAZ5apogz8iaTG3M">
    </div>

    <div class="control-group">
      <label for="calendarId">Calendar ID:</label>
      <input type="text" id="calendarId" placeholder="calendar@gmail.com" value="76961a30394a7092a9c09e2b0e6c075dd7ed95105d01b023e09d55d0d22e6d27@group.calendar.google.com">
    </div>

    <div class="control-group">
      <label for="year">Year:</label>
      <input type="number" id="year" value="2025" style="width: 120px;">
      <label for="month" style="display: inline; margin-left: 1rem;">Month (1-12):</label>
      <input type="number" id="month" value="12" min="1" max="12" style="width: 80px;">
    </div>

    <button onclick="fetchSingleMonth()">Fetch Single Month (Current Approach)</button>
    <button onclick="fetchThreeMonths()">Fetch Three Months (Better Approach)</button>
    <button onclick="compareApproaches()">Compare Both Approaches</button>
  </div>

  <div id="results" class="results" style="display: none;">
    <div id="resultsContent"></div>
  </div>

  <script>
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleString('en-US', {
        weekday: 'short',
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function displayEvents(events, title) {
      if (!events || events.length === 0) {
        return `<div class="warning">${title}: No events found</div>`;
      }

      let html = `<h4>${title} (${events.length} events)</h4>`;
      events.forEach(event => {
        const start = event.start.dateTime || event.start.date;
        const isRecurring = event.recurringEventId ? ' (Recurring)' : '';
        html += `
          <div class="event-item">
            <strong>${event.summary}${isRecurring}</strong>
            <small>Start: ${formatDate(start)}</small>
            ${event.recurringEventId ? `<br><small>Recurring Event ID: ${event.recurringEventId}</small>` : ''}
          </div>
        `;
      });
      return html;
    }

    async function fetchCalendar(apiKey, calendarId, timeMin, timeMax) {
      const params = new URLSearchParams({
        key: apiKey,
        timeMin: timeMin,
        timeMax: timeMax,
        singleEvents: 'true',
        orderBy: 'startTime',
        maxResults: '2500'
      });

      const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events?${params}`;

      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return await response.json();
      } catch (error) {
        console.error('Fetch error:', error);
        throw error;
      }
    }

    async function fetchSingleMonth() {
      const apiKey = document.getElementById('apiKey').value;
      const calendarId = document.getElementById('calendarId').value;
      const year = parseInt(document.getElementById('year').value);
      const month = parseInt(document.getElementById('month').value) - 1; // 0-indexed

      const startDate = new Date(year, month, 1);
      const endDate = new Date(year, month + 1, 0, 23, 59, 59, 999);

      const results = document.getElementById('results');
      const content = document.getElementById('resultsContent');

      results.style.display = 'block';
      content.innerHTML = '<p>Fetching...</p>';

      try {
        const data = await fetchCalendar(apiKey, calendarId, startDate.toISOString(), endDate.toISOString());

        content.innerHTML = `
          <div class="result-section">
            <h3>Single Month Approach (Current Bug)</h3>
            <p><strong>Date Range:</strong> ${startDate.toDateString()} to ${endDate.toDateString()}</p>
            <div class="warning">
              <strong>⚠️ Problem:</strong> This approach only fetches events that START within the exact month boundaries.
              Recurring events that originated in previous months may be missing their instances in this month.
            </div>
            ${displayEvents(data.items, 'Events Found')}
            <details style="margin-top: 1rem;">
              <summary>Raw API Response</summary>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </details>
          </div>
        `;
      } catch (error) {
        content.innerHTML = `<div class="warning">Error: ${error.message}</div>`;
      }
    }

    async function fetchThreeMonths() {
      const apiKey = document.getElementById('apiKey').value;
      const calendarId = document.getElementById('calendarId').value;
      const year = parseInt(document.getElementById('year').value);
      const month = parseInt(document.getElementById('month').value) - 1;

      // Previous month start
      const startDate = new Date(year, month - 1, 1);
      // Next month end
      const endDate = new Date(year, month + 2, 0, 23, 59, 59, 999);

      const results = document.getElementById('results');
      const content = document.getElementById('resultsContent');

      results.style.display = 'block';
      content.innerHTML = '<p>Fetching...</p>';

      try {
        const data = await fetchCalendar(apiKey, calendarId, startDate.toISOString(), endDate.toISOString());

        // Filter to just the target month for display
        const targetMonth = month;
        const targetYear = year;
        const eventsInTargetMonth = data.items.filter(event => {
          const start = new Date(event.start.dateTime || event.start.date);
          return start.getMonth() === targetMonth && start.getFullYear() === targetYear;
        });

        content.innerHTML = `
          <div class="result-section">
            <h3>Three Month Window Approach (Better)</h3>
            <p><strong>Fetch Range:</strong> ${startDate.toDateString()} to ${endDate.toDateString()}</p>
            <p><strong>Display Month:</strong> ${new Date(year, month, 1).toLocaleString('en-US', { month: 'long', year: 'numeric' })}</p>
            <div style="background: #d1fae5; border-left: 3px solid #10b981; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
              <strong>✓ Solution:</strong> Fetching a wider date range captures recurring events that originated outside the target month.
            </div>
            <p><strong>Total events fetched:</strong> ${data.items.length}</p>
            <p><strong>Events in target month:</strong> ${eventsInTargetMonth.length}</p>
            ${displayEvents(eventsInTargetMonth, 'Events in Target Month')}
            <details style="margin-top: 1rem;">
              <summary>All Fetched Events (including adjacent months)</summary>
              ${displayEvents(data.items, 'All Events')}
            </details>
          </div>
        `;
      } catch (error) {
        content.innerHTML = `<div class="warning">Error: ${error.message}</div>`;
      }
    }

    async function compareApproaches() {
      const apiKey = document.getElementById('apiKey').value;
      const calendarId = document.getElementById('calendarId').value;
      const year = parseInt(document.getElementById('year').value);
      const month = parseInt(document.getElementById('month').value) - 1;

      const results = document.getElementById('results');
      const content = document.getElementById('resultsContent');

      results.style.display = 'block';
      content.innerHTML = '<p>Fetching both approaches...</p>';

      try {
        // Single month
        const startDateSingle = new Date(year, month, 1);
        const endDateSingle = new Date(year, month + 1, 0, 23, 59, 59, 999);
        const singleMonthData = await fetchCalendar(apiKey, calendarId, startDateSingle.toISOString(), endDateSingle.toISOString());

        // Three months
        const startDateThree = new Date(year, month - 1, 1);
        const endDateThree = new Date(year, month + 2, 0, 23, 59, 59, 999);
        const threeMonthData = await fetchCalendar(apiKey, calendarId, startDateThree.toISOString(), endDateThree.toISOString());

        const targetMonth = month;
        const targetYear = year;
        const eventsInTargetMonth = threeMonthData.items.filter(event => {
          const start = new Date(event.start.dateTime || event.start.date);
          return start.getMonth() === targetMonth && start.getFullYear() === targetYear;
        });

        const missingEvents = eventsInTargetMonth.filter(e1 =>
          !singleMonthData.items.some(e2 => e2.id === e1.id)
        );

        content.innerHTML = `
          <div class="result-section">
            <h3>Comparison: Single Month vs Three Month Window</h3>
            <p><strong>Target Month:</strong> ${new Date(year, month, 1).toLocaleString('en-US', { month: 'long', year: 'numeric' })}</p>

            <div class="comparison">
              <div>
                <h4>Single Month Approach</h4>
                <p><strong>Date Range:</strong> ${startDateSingle.toDateString()} to ${endDateSingle.toDateString()}</p>
                <p><strong>Events Found:</strong> ${singleMonthData.items.length}</p>
              </div>
              <div>
                <h4>Three Month Window</h4>
                <p><strong>Date Range:</strong> ${startDateThree.toDateString()} to ${endDateThree.toDateString()}</p>
                <p><strong>Events in Target Month:</strong> ${eventsInTargetMonth.length}</p>
              </div>
            </div>

            ${missingEvents.length > 0 ? `
              <div class="warning" style="margin-top: 1rem;">
                <strong>⚠️ ${missingEvents.length} event(s) missing with single month approach!</strong>
              </div>
              ${displayEvents(missingEvents, 'Missing Events (Only Found with 3-Month Window)')}
            ` : `
              <div style="background: #d1fae5; border-left: 3px solid #10b981; padding: 1rem; margin-top: 1rem; border-radius: 4px;">
                <strong>✓ Both approaches found the same events for this month.</strong>
              </div>
            `}

            <details style="margin-top: 1rem;">
              <summary>Single Month Events</summary>
              ${displayEvents(singleMonthData.items, 'Single Month Results')}
            </details>

            <details style="margin-top: 1rem;">
              <summary>Three Month Events (Target Month Only)</summary>
              ${displayEvents(eventsInTargetMonth, 'Three Month Results (Filtered to Target)')}
            </details>
          </div>
        `;
      } catch (error) {
        content.innerHTML = `<div class="warning">Error: ${error.message}</div>`;
      }
    }
  </script>
</body>
</html>
