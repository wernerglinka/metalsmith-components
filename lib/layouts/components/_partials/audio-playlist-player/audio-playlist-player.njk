{% from "components/_partials/image/image.njk" import image %}
{% from "components/_partials/icon/icon.njk" import icon %}

{% macro audioPlaylist(playlistName, options = {}, playlistsData = {}) %}
  {% set playlist = playlistsData[playlistName] %}
  {% if not playlist %}
    <div class="audio-playlist-error" role="alert" aria-live="assertive">
      <p>
        <span class="sr-only">Error: </span>
        Playlist "{{ playlistName }}" not found
      </p>
    </div>
  {% else %}
    <div class="audio-playlist" data-playlist="{{ playlistName }}" data-platform="{{ playlist.platform }}" data-podcast-url="{{ playlist.podcastUrl }}">
      
      <!-- Playlist Header -->
      <div class="playlist-header">
        {% if playlist.coverImage %}
          <div class="playlist-cover">
            {% set coverData = {
              src: playlist.coverImage,
              alt: playlist.title + ' cover image'
            } %}
            {{ image(coverData) }}
          </div>
        {% endif %}
        
        <div class="playlist-info">
          <h3 class="playlist-title">{{ playlist.title }}</h3>
          {% if playlist.description %}
            <p class="playlist-description">{{ playlist.description }}</p>
          {% endif %}
          <div class="playlist-meta">
            {% if playlist.episodes %}
              <span class="track-count">{{ playlist.episodes.length }} episodes</span>
            {% elif playlist.stats %}
              <span class="track-count">{{ playlist.stats.totalEpisodes }} episodes • {{ playlist.stats.frequency }}</span>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Latest Episode or Current Track Display -->
      <div class="current-track" data-current-track>
        <div class="track-info">
          <div class="track-thumbnail">
            {% if playlist.latestEpisode %}
              <img src="{{ playlist.coverImage }}" alt="{{ playlist.latestEpisode.title }}" data-current-thumbnail>
            {% else %}
              <img src="/assets/images/sample12.jpg" alt="Select a track" data-current-thumbnail>
            {% endif %}
          </div>
          <div class="track-details">
            {% if playlist.latestEpisode %}
              <h4 class="track-title" data-current-title>{{ playlist.latestEpisode.title }}</h4>
              <p class="track-artist" data-current-artist>{{ playlist.title }} • Episode {{ playlist.latestEpisode.episodeNumber }}</p>
              <p class="track-description" data-current-description>{{ playlist.latestEpisode.description }}</p>
            {% else %}
              <h4 class="track-title" data-current-title>Select a track to start playing</h4>
              <p class="track-artist" data-current-artist>{{ playlist.title }}</p>
              <p class="track-description" data-current-description>{{ playlist.description }}</p>
            {% endif %}
          </div>
        </div>
        
        <!-- Audio Player for Internal Tracks -->
        <div class="audio-player" data-audio-player style="display: none;">
          <audio controls data-audio-element aria-label="Playlist audio player">
            <source src="" type="audio/ogg" data-audio-ogg>
            <source src="" type="audio/mpeg" data-audio-mp3>
            Your browser does not support the audio element.
          </audio>
        </div>
        
        <!-- Listen Now Button for External Podcasts -->
        {% if playlist.podcastUrl %}
          <div class="external-sources" data-external-sources>
            <div class="source-links" data-source-links>
              <a href="{{ playlist.podcastUrl }}" target="_blank" rel="noopener noreferrer" class="source-link listen-now-button" style="--platform-color: {% if playlist.platform == 'apple' %}#000{% elif playlist.platform == 'spotify' %}#1db954{% elif playlist.platform == 'youtube' %}#ff0000{% else %}var(--color-primary){% endif %}">
                <span class="source-icon" data-icon="{% if playlist.platform == 'apple' %}music{% elif playlist.platform == 'spotify' %}music{% elif playlist.platform == 'youtube' %}play-circle{% else %}headphones{% endif %}"></span>
                Listen on {{ playlist.platform | title }}{% if playlist.platform == 'apple' %} Podcasts{% endif %}
              </a>
            </div>
          </div>
        {% else %}
          <div class="external-sources" data-external-sources style="display: none;">
            <div class="source-links" data-source-links></div>
          </div>
        {% endif %}
      </div>

      <!-- Track List (only for podcasts with episodes array) -->
      {% if options.showTrackList !== false and playlist.episodes %}
        <div class="track-list">
          <h4 class="track-list-title">Episodes</h4>
          <ul class="tracks">
            {% for track in playlist.episodes %}
              <li class="track-item" data-track-id="{{ track.id }}">
                <button class="track-button" data-track-button aria-label="Play episode: {{ track.title }}">
                  <div class="track-thumbnail-small">
                    {% if track.thumbnail %}
                      {% set thumbData = {
                        src: track.thumbnail,
                        alt: track.title + ' thumbnail'
                      } %}
                      {{ image(thumbData) }}
                    {% endif %}
                  </div>
                  
                  <div class="track-info-small">
                    <span class="track-title-small">{{ track.title }}</span>
                    <span class="track-artist-small">{{ track.artist }}</span>
                    <span class="track-duration">{{ track.duration }}</span>
                  </div>
                  
                  <div class="track-type-indicator">
                    {% if track.audioFile %}
                      {% set playIcon = { icon: 'play' } %}
                      {{ icon(playIcon) }}
                    {% else %}
                      {% set linkIcon = { icon: 'external-link' } %}
                      {{ icon(linkIcon) }}
                    {% endif %}
                  </div>
                </button>
                
                <!-- Hidden data for JavaScript -->
                <script type="application/json" data-track-data>
                  {
                    "id": "{{ track.id }}",
                    "title": "{{ track.title }}",
                    "artist": "{{ playlist.title }}",
                    "duration": "{{ track.duration }}",
                    "thumbnail": "{{ track.thumbnail }}",
                    "description": "{{ track.description }}"{% if track.audioFile %},
                    "audioFile": "{{ track.audioFile }}"{% endif %}
                  }
                </script>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    </div>
  {% endif %}
{% endmacro %}